<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Velocímetro GPS</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<!-- Evitar cache raro -->
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">

<style>
  body {
    margin: 0;
    height: 100vh;
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    color: #7CFF00; /* verde claro */
    overflow: hidden;
  }

  #container {
    text-align: center;
  }

  #speed {
    font-size: 22vw;
    font-weight: 700;
    line-height: 1;
  }

  #unit {
    font-size: 5vw;
    opacity: 0.6;
  }

  #status {
    font-size: 3.5vw;
    margin-top: 2vh;
    opacity: 0.4;
  }
</style>
</head>
<body>

<div id="container">
  <div id="speed">0</div>
  <div id="unit">km/h</div>
  <div id="status">Buscando GPS…</div>
</div>

<script>
/* ==========================
   Registrar Service Worker
   ========================== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}

/* ==========================
   Wake Lock (pantalla activa)
   ========================== */
let wakeLock = null;

async function requestWakeLock() {
  try {
    if ("wakeLock" in navigator) {
      wakeLock = await navigator.wakeLock.request("screen");
    }
  } catch (_) {}
}

document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    requestWakeLock();
  }
});

requestWakeLock();

/* ==========================
   Velocímetro GPS
   ========================== */
const speedEl = document.getElementById("speed");
const statusEl = document.getElementById("status");

let lastSpeed = 0;
let hasFix = false;

function updateSpeed(ms) {
  const kmh = ms * 3.6;
  const smooth = (lastSpeed * 0.6) + (kmh * 0.4);
  lastSpeed = smooth;
  speedEl.textContent = Math.round(smooth);
}

if ("geolocation" in navigator) {
  navigator.geolocation.watchPosition(
    pos => {
      const v = pos.coords.speed;
      if (v !== null && v >= 0) {
        updateSpeed(v);
        if (!hasFix) {
          statusEl.textContent = "GPS fijado";
          hasFix = true;
        }
      }
    },
    () => {
      if (hasFix) {
        statusEl.textContent = "Señal GPS débil";
      }
    },
    {
      enableHighAccuracy: true,
      maximumAge: 500,
      timeout: 5000
    }
  );
} else {
  statusEl.textContent = "GPS no disponible";
}

/* ==========================
   Bloquear orientación
   ========================== */
if (screen.orientation && screen.orientation.lock) {
  screen.orientation.lock("portrait").catch(() => {});
}
</script>

</body>
</html>


